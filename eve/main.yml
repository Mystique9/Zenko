version: "0.2"

branches:
  default:
    stage: "pre-merge"

models:
  - Upload: &upload_artifacts
      source: artifacts
      urls:
        - "*"
  - env: &global_env
      AWS_S3_BUCKET_NAME: zenko-aws-target-bucket
      AWS_S3_BUCKET_NAME_2: zenko-aws-target-bucket-2
      AWS_S3_BACKBEAT_BUCKET_NAME: zenko-aws-crr-target-bucket
      AWS_S3_BACKBEAT_SRC_BUCKET_NAME: zenko-aws-crr-src-bucket
      AZURE_BACKEND_CONTAINER_NAME: zenko-azure-target-bucket
      AZURE_BACKEND_CONTAINER_NAME_2: zenko-azure-target-bucket-2
      AZURE_BACKBEAT_CONTAINER_NAME: zenko-azure-crr-target-bucket
      AZURE_BACKBEAT_SRC_CONTAINER_NAME: zenko-azure-crr-src-bucket
      GCP_BUCKET_NAME: zenko-gcp-target-bucket
      GCP_MPU_BUCKET_NAME: zenko-gcp-mpu-bucket
      GCP_BUCKET_NAME_2: zenko-gcp-target-bucket-2
      GCP_MPU_BUCKET_NAME_2: zenko-gcp-mpu-bucket-2
      GCP_CRR_BUCKET_NAME: zenko-gcp-crr-target-bucket
      GCP_CRR_SRC_BUCKET_NAME: zenko-gcp-crr-src-bucket
      GCP_CRR_MPU_BUCKET_NAME: zenko-gcp-crr-mpu-bucket
      MULTI_CRR_SRC_BUCKET: zenko-multi-crr-src-bucket

stages:
  pre-merge:
    worker: &pod
      type: kube_pod
      path: eve/workers/zenko.yaml
    steps:
    - TriggerStages:
        name: trigger all the tests
        stage_names:
        - helm_test_kube_1.9.6

  helm_test_kube_1.9.6:
    worker:
      <<: *pod
      service:
        requests:
          version: "1.9.6"
        namespaces:
        - "testNamespace"    # <<< the default namespace for that stage
    steps:
    - Git: &git_pull
        name: git pull
        repourl: "%(prop:git_reference)s"
        mode: full
        method: clobber
        retryFetch: true
        haltOnFailure: true
    - ShellCommand: &install_tiller
        name: install helm (tiller into kubernetes)
        command: >-
          helm init --wait
        haltOnFailure: true
        env:
          TILLER_NAMESPACE: '%(prop:testNamespace)s'
    - ShellCommand:
        name: Install needed helm repos
        command: |-
          helm repo add incubator http://storage.googleapis.com/kubernetes-charts-incubator
          helm repo add orbit-simulator https://raw.githubusercontent.com/tmacro/orbit-simulator/master/
        haltOnFailure: true
        env:
          TILLER_NAMESPACE: '%(prop:testNamespace)s'
    - ShellCommandWithSecrets:
        name: Start orbit simulator
        command: >-
          sh start_orbit_simulator.sh
        workdir: build/eve/workers
        haltOnFailure: true
        env:
          <<: *global_env
          TILLER_NAMESPACE: '%(prop:testNamespace)s'
    - ShellCommand:
        name: Retrieve dependency
        command: >-
           helm dep build charts/zenko
        haltOnFailure: true
        env:
          TILLER_NAMESPACE: '%(prop:testNamespace)s'
    - ShellCommand:
        name: Install Zenko !
        command: >-
          helm upgrade zenko-test --namespace %(prop:testNamespace)s
          --install charts/zenko --wait
          --set prometheus.rbac.create=false
          --set zenko-queue.rbac.enabled=false
          --set redis-ha.rbac.create=false
          "$(./ci_env.sh)"
        haltOnFailure: true
        workdir: build/eve/workers
        env:
          <<: *global_env
          TILLER_NAMESPACE: '%(prop:testNamespace)s'
    - ShellCommand:
        name: Test zenko
        command: |-
          sleep 90
          make helm-test
        workdir: build/tests
        haltOnFailure: true
        env:
          <<: *global_env
          TILLER_NAMESPACE: '%(prop:testNamespace)s'
          ZENKO_K8S_NAMESPACE: '%(prop:testNamespace)s'
          ZENKO_HELM_RELEASE: 'zenko-test'
    - Upload: *upload_artifacts
